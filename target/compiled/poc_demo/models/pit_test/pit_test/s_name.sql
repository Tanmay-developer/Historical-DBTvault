














-- Generated by dbtvault.

WITH source_data AS (
    SELECT a.`hsh_ky_cli_cd`, a.`rcrd_hsh_id`, a.`name`, a.EFFECTIVE_FROM, a.`ld_dt_tm`, a.`rcrd_src_nm`
    FROM ndb.v_stg_s_name AS a
    WHERE a.`hsh_ky_cli_cd` IS NOT NULL
),

latest_records AS (
    SELECT a.`hsh_ky_cli_cd`, a.`rcrd_hsh_id`, a.`ld_dt_tm`
    FROM (
        SELECT current_records.`hsh_ky_cli_cd`, current_records.`rcrd_hsh_id`, current_records.`ld_dt_tm`,
            RANK() OVER (
                PARTITION BY current_records.`hsh_ky_cli_cd`
                ORDER BY current_records.`ld_dt_tm` DESC
            ) AS rank
        FROM ndb.s_name AS current_records
            JOIN (
                SELECT DISTINCT source_data.`hsh_ky_cli_cd`
                FROM source_data
            ) AS source_records
                ON current_records.`hsh_ky_cli_cd` = source_records.`hsh_ky_cli_cd`
    ) AS a
    WHERE a.rank = 1
),

records_to_insert AS (
    SELECT DISTINCT stage.`hsh_ky_cli_cd`, stage.`rcrd_hsh_id`, stage.`name`, stage.EFFECTIVE_FROM, stage.`ld_dt_tm` AS `ld_dt_tm`, stage.`rcrd_src_nm` AS `rcrd_src_nm`
    FROM source_data AS stage
        LEFT JOIN latest_records
            ON latest_records.`hsh_ky_cli_cd` = stage.`hsh_ky_cli_cd`
            WHERE latest_records.`rcrd_hsh_id` != stage.`rcrd_hsh_id`
                OR latest_records.`rcrd_hsh_id` IS NULL
)

SELECT * FROM records_to_insert